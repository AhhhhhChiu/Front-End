# TCP/IP基础

TCP/IP 是指由 FTP、SMTP、TCP、UDP、IP 等协议构成的能够在多个不同网络间实现信息传输的协议簇。

## TCP/IP 与 OSI 模型

|TCP/IP|OSI|
|-|-|
|应用层|应用层|
|-|表示层|
|-|会话层|
|传输层|传输层|
|网络层|网络层|
|网络接口层|数据链路层|
|物理层|物理层|

## 数据链路层

...

## 网络层

### 概述

**主要任务**：实现网络互连，进而实现数据包在个网络之间的传输
**主要解决问题**：
- 网络层想运输层提供`可靠传输`还是`不可靠传输`服务
- 网络层寻址问题
- 路由选择问题

### 网络层提供的两种服务 *

|-|面向连接的虚电路服务|无连接的数据报服务|
|-|-|-|
|思路|可靠通信应当由网络来保证|可靠通信应当由用户主机来保证|
|连接的建立|必须建立网络层连接|不需要建立网络层连接|
|终点地址|仅在连接建立阶段使用，每个分组使用短的虚电路号|每个分组都有终点的完整地址|
|分组的转发|属于同一条虚电路的分组均按照同一路由进行转发|每个分组可走不同的路由|
|当结点出故障时|所有通过出故障的结点的虚电路均不能工作|出故障的结点可能会丢失分组，-些路由可能会发生变化|
|分组的顺序|总是按发送顺序到达终点|到达终点时不一-定按发送顺序|
|服务质量保证|可以将通信资源提前分配给每一个虚电路， 容易实现|很难实现

### IPv4

#### 概述 *

IPv4就是给因特网上的每一台主机或路由器的每一个接口分配一个在全世界范围内是唯一的`32`比特的标识符。由于不方便阅读记录以及输入，因此采用`点分十进制表示法`。IPv4编址经历了三个历史阶段，分别是：
1. 分类编址
2. 划分子网
3. 无分类编址

#### 分类编址

- 只有 A B C 类地址可分配给网络中的主机或路由器的各接口
- 主机号全0的地址是网络地址，全1是广播地址，都不能分配

![地址类别](./images/地址类别.png)

![特殊IP](./images/特殊IP.png)

#### 划分子网

为新增网络申请新的网络号会带来以下弊端:

- 需要等待时间和花费更多的费用
- 会增加其他路由器中路由表记录的数量
- 浪费原有网络号中剩余的大量IP地址

可以从主机号部分借用一部分比特作为子网号

32比特的子网掩码可以表明分类IP地址的主机号部分被借用了几个比特作为子网号

- 子网掩码使用连续的比特1来对应网络号和子网号
- 子网掩码使用连续的比特0来对应主机号
- 将划分子网的IPv4地址与其相应的子网掩码进行逻辑与运算就可得到IPv4地址所在子网的网络地址

```
例如 192.168.1.2 的子网掩码是 255.255.255.128
即 11111111 11111111 11111111 10000000
前三个字节为网络号，向主机号部分借用1个比特作为子网号
即划分出来的子网数量是2
```

给定一个分类的IP地址和其相应的子网掩码，就可知道子网划分的细节:

- 划分出的子网数量
- 每个子网可分配的IP地址数量
- 每个子网的网络地址和广播地址
- 每个子网可分配的最小和最大地址

```
还是上面的例子，我们可以得出
- 划分出的子网数量 --- 2
- 每个子网可分配的IP地址数量 --- 2^7 - 2
- 每个子网的网络地址和广播地址（懒得算成点分十进制了╥﹏╥）
  - 第一个子网的网络地址  --- 11111111 11111111 11111111 00000000
  - 第一个子网的广播地址  --- 11111111 11111111 11111111 01111111
  - 第二个子网的网络地址  --- 11111111 11111111 11111111 10000000
  - 第二个子网的广播地址  --- 11111111 11111111 11111111 11111111
- 每个子网可分配的最小和最大地址
  - 第一个子网可分配的最小地址  --- 11111111 11111111 11111111 00000001
  - 第一个子网可分配的最大地址  --- 11111111 11111111 11111111 01111110
  - 第二个子网可分配的最小地址  --- 11111111 11111111 11111111 10000001
  - 第二个子网可分配的最大地址  --- 11111111 11111111 11111111 11111110
```

默认的子网掩码是指在未划分子网的情况下使用的子网掩码。

- A类: 255.0.0.0
- B类: 255.255.0.0
- C类: 255.255.255.0

#### 无分类编址

划分子网在一定程度上缓解了因特网在发展中遇到的困难，但是数量巨大的C类网因为其地址空间太小并没有得到充分使用，而因特网的IP地址仍在加速消耗，整个IPv4地址空间面临全部耗尽的威胁。为此，因特网工程任务组IETF又提出了采用无分类编址的方法来解决IP地址紧张的问题，同时还专门成立IPv6工作组负责研究新版本IP以彻底解决IP地址耗尽问题。

1993年， IETF发布了无分类域间路由选择CIDR(Classless Inter- Domain Routing)的RFC文档: RFC 1517~1519和1520

- CIDR消除了 传统的A类、B类和C类地址，以及划分子网的概念;
- CIDR可以更加有效地分配IPv4的地址空间， 并且可以在新的IPv6使用之前允许因特网的规模继续增长。

CIDR使用“斜线记法”，或称CIDR记法。即在IPv4地址后面加上斜线`/`，在斜线后面写上网络前缀所占的比特数量。

CIDR实际上是将网络前缀都相同的连续的IP地址组成-个“CIDR地址块”。

我们只要知道CIDR地址块中的任何一个地址，就可以知道该地址块的全部细节:

- 地址块的最小地址
- 地址块的最大地址
- 地址块中的地址数量
- 地址块聚合某类网络(A类、 B类或C类)的数量
- 地址掩码 (也可继续称为子网掩码)

路由聚合(构造超网)的方法是找共同前缀

网络前缀越长，地址块越小，路由越具体;

若路由器查表转发分组时发现有多条路由可选，则选择网络前缀最长的那条,这称为最长前缀匹配，因为这样的路由更具体
